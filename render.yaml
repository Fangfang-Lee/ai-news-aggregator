# ============================================================
# Render Blueprint — AI News Aggregator (免费方案)
# ============================================================
# Deploy: Render Dashboard → New → Blueprint → Connect repo
#
# 全部免费:
#   - Web Service (Free):  $0/月  ← 15 分钟无访问后休眠, 冷启动 ~30s
#   - Redis KVS (Free):   $0/月  (25 MB)
#   - Supabase PostgreSQL: $0/月  (500 MB)
#
# 定时抓取: 用 cron-job.org (免费) 每 5 分钟 POST /api/content/fetch-all
# ============================================================

services:
  # ─── FastAPI Web Service ───────────────────────────────────
  - type: web
    name: ai-news-backend
    runtime: python
    region: singapore
    plan: free
    buildCommand: ./build.sh
    startCommand: cd backend && uvicorn app.main:app --host 0.0.0.0 --port $PORT
    # healthCheckPath 已移除 — 避免 DB/Redis 暂不可用时 Render 判定部署失败
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.0"
      - key: DATABASE_URL
        sync: false          # ← Supabase 连接字符串, 手动填入 Dashboard
      - key: REDIS_URL
        fromService:
          name: ai-news-redis
          type: keyvalue
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          name: ai-news-redis
          type: keyvalue
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          name: ai-news-redis
          type: keyvalue
          property: connectionString
      - key: DEEPSEEK_API_KEY
        sync: false          # ← 手动填入 Dashboard
      - key: CONTENT_MIN_DATE
        value: "2026-02-10"
      - key: CORS_ORIGINS
        value: '["https://ai-news-backend.onrender.com"]'

  # ─── Redis Key-Value Store ─────────────────────────────────
  - type: keyvalue
    name: ai-news-redis
    plan: free               # 25 MB, 足够缓存
    region: singapore
    maxmemoryPolicy: allkeys-lru
    ipAllowList:
      - source: 0.0.0.0/0
        description: everywhere
